"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("crypto"),r=require("nanoid"),n=e(require("secure-password")),o=e(require("cookie-session")),a=e(require("passport")),i=require("b64-lite"),s=e(require("cookie")),u=require("date-fns"),c=require("jsonwebtoken"),l=require("next/dist/next-server/server/api-utils");function p(e,t,r,n,o,a,i){try{var s=e[a](i),u=s.value}catch(e){return void r(e)}s.done?t(u):Promise.resolve(u).then(n,o)}function f(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){p(a,n,o,i,s,"next",e)}function s(e){p(a,n,o,i,s,"throw",e)}i(void 0)}))}}function h(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function d(e,t,r){return t&&h(e.prototype,t),r&&h(e,r),e}function v(){return(v=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function y(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}function b(e){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function w(e,t){return(w=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function m(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function x(e,t,r){return(x=m()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var o=new(Function.bind.apply(e,n));return r&&w(o,r.prototype),o}).apply(null,arguments)}function g(e){var t="function"==typeof Map?new Map:void 0;return(g=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return x(e,arguments,b(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),w(r,e)})(e)}function k(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)t.indexOf(r=a[n])>=0||(o[r]=e[r]);return o}function S(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function E(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return S(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?S(e,void 0):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(r=e[Symbol.iterator]()).next.bind(r)}var D,_=(function(e){var t=function(e){var t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",a=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var o=Object.create((t&&t.prototype instanceof p?t:p).prototype),a=new S(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(o,a){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===o)throw a;return{value:void 0,done:!0}}for(r.method=o,r.arg=a;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var u=c(e,t,r);if("normal"===u.type){if(n=r.done?"completed":"suspendedYield",u.arg===l)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n="completed",r.method="throw",r.arg=u.arg)}}}(e,r,a),o}function c(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var l={};function p(){}function f(){}function h(){}var d={};d[o]=function(){return this};var v=Object.getPrototypeOf,y=v&&v(v(E([])));y&&y!==t&&r.call(y,o)&&(d=y);var b=h.prototype=p.prototype=Object.create(d);function w(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function m(e,t){var n;this._invoke=function(o,a){function i(){return new t((function(n,i){!function n(o,a,i,s){var u=c(e[o],e,a);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==typeof p&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(p).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(u.arg)}(o,a,n,i)}))}return n=n?n.then(i,i):i()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=c(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var o=n.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function g(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(g,this),this.reset(!0)}function E(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:D}}function D(){return{value:void 0,done:!0}}return f.prototype=b.constructor=h,h.constructor=f,f.displayName=s(h,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===f||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,s(e,i,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(m.prototype),m.prototype[a]=function(){return this},e.AsyncIterator=m,e.async=function(t,r,n,o,a){void 0===a&&(a=Promise);var i=new m(u(t,r,n,o),a);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),s(b,i,"Generator"),b[o]=function(){return this},b.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=E,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],i=a.completion;if("root"===a.tryLoc)return n("end");if(a.tryLoc<=this.prev){var s=r.call(a,"catchLoc"),u=r.call(a,"finallyLoc");if(s&&u){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(s){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),k(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;k(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:E(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}}(D={exports:{}}),D.exports),O=function(e){function t(t){var r;return void 0===t&&(t="You must be logged in to access this"),(r=e.call(this,t)||this).name="AuthenticationError",r.statusCode=401,r}return y(t,e),d(t,[{key:"_clearStack",get:function(){return!0}}]),t}(g(Error)),C=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).name="CSRFTokenMismatchError",t.statusCode=401,t}return y(t,e),d(t,[{key:"_clearStack",get:function(){return!0}}]),t}(g(Error)),P=function(e){function t(t){var r;return void 0===t&&(t="You are not authorized to access this"),(r=e.call(this,t)||this).name="AuthorizationError",r.statusCode=403,r}return y(t,e),d(t,[{key:"_clearStack",get:function(){return!0}}]),t}(g(Error)),T=function(e){return void 0===e&&(e=""),t.createHash("sha256").update(e).digest("hex")},A=function(e){return void 0===e&&(e=32),r.nanoid(e)},j=function(){return new n},I=v({},n,{hash:function(e){return f(_.mark((function t(){return _.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e){t.next=2;break}throw new O;case 2:return t.next=4,j().hash(Buffer.from(e));case 4:return t.abrupt("return",t.sent.toString("base64"));case 6:case"end":return t.stop()}}),t)})))()},verify:function(e,t){return f(_.mark((function r(){var n;return _.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(e&&t){r.next=2;break}throw new O;case 2:return r.prev=2,r.next=5,j().verify(Buffer.from(t),Buffer.from(e,"base64"));case 5:r.t0=n=r.sent,r.next=r.t0===I.VALID||r.t0===I.VALID_NEEDS_REHASH?9:10;break;case 9:return r.abrupt("return",n);case 10:throw new O;case 13:throw r.prev=13,r.t1=r.catch(2),new O;case 16:case"end":return r.stop()}}),r,null,[[2,13]])})))()}}),R=function(){var e=f(_.mark((function e(t){return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,j().hash(Buffer.from(t));case 2:return e.abrupt("return",e.sent.toString("base64"));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),L=function(){var e=f(_.mark((function e(t,r){return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,j().verify(Buffer.from(r),Buffer.from(t,"base64"));case 3:return e.abrupt("return",e.sent);case 6:return e.prev=6,e.t0=e.catch(0),console.error(e.t0),e.abrupt("return",!1);case 10:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(t,r){return e.apply(this,arguments)}}(),z=function(){var e=f(_.mark((function e(t,r,n){var o,a,i;return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.user.findFirst({where:{email:r.toLowerCase()}});case 2:if((o=e.sent)&&o.hashedPassword){e.next=5;break}throw new O;case 5:return e.next=7,L(o.hashedPassword,n);case 7:e.t0=e.sent,e.next=e.t0===I.VALID?10:e.t0===I.VALID_NEEDS_REHASH?11:17;break;case 10:return e.abrupt("break",18);case 11:return e.next=13,R(n);case 13:return a=e.sent,e.next=16,t.user.update({where:{id:o.id},data:{hashedPassword:a}});case 16:return e.abrupt("break",18);case 17:throw new O;case 18:return i=k(o,["hashedPassword"]),e.abrupt("return",i);case 20:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}();function N(e){var t=[];if(e.middleware){if(!Array.isArray(e.middleware))throw new Error("'middleware' exported from "+e._meta.name+" must be an array");t.push.apply(t,e.middleware)}return t}function q(e,t,r,n){return F.apply(this,arguments)}function F(){return(F=f(_.mark((function e(t,r,n,o){var a,i,s,u,c,l;return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=void 0===(i=(a=void 0===o?{}:o).throwOnError)||i,c=void 0===(u=a.stackPrintOnError)||u,r.blitzCtx||(r.blitzCtx={}),r._blitz||(r._blitz={}),l=Array.isArray(n)?M(n):n,e.prev=4,e.next=7,l(t,r,(function(e){if(e)throw e}));case 7:e.next=16;break;case 9:if(e.prev=9,e.t0=e.catch(4),"GET"===t.method?console.log("Error while processing the request"):r.writableFinished?console.log("Error occured in middleware after the response was already sent to the browser"):(r.statusCode=e.t0.statusCode||e.t0.status||500,r.end(e.t0.message||r.statusCode.toString()),console.log("Error while processing the request")),e.t0._clearStack&&delete e.t0.stack,c?console.log(e.t0):console.log(e.t0,!0,!1,!1),!s){e.next=16;break}throw e.t0;case 16:case"end":return e.stop()}}),e,null,[[4,9]])})))).apply(this,arguments)}function M(e){if(!Array.isArray(e))throw new TypeError("Middleware stack must be an array!");for(var t,r=E(e);!(t=r()).done;)if("function"!=typeof t.value)throw new TypeError("Middleware must be composed of functions!");return function(t,r,n){var o=-1;return function n(a,i){if(i)return Promise.reject(i);if(a<=o)throw new Error("next() called multiple times");o=a;var s=e[a];if(!s)return Promise.resolve();try{return Promise.resolve(s(t,r,n.bind(null,a+1)))}catch(i){return Promise.reject(i)}}(0).then(n)}}function B(e,t,r,n){return n(e,t),r()}function Y(e,t,r,n){return new Promise((function(o,a){n(e,t,(function(e){e?a(e):o(r())}))}))}function U(e){var t=e.length<3?B:Y;return function(r,n,o){return t(r,n,o,e)}}var H=function(e,t,r){e.protocol=function(e){if(e.connection.encrypted)return"https";var t=e.headers&&e.headers["x-forwarded-proto"];return t?t.split(/\s*,\s*/)[0]:"http"}(e),r()};function J(e){var t=e.headers.host,r=!1;return t&&(r="localhost"===(t=t.split(":")[0])),r}function G(e,t){if(!e)throw new Error(t)}var K="v0";function V(e,t){if(!e)throw new Error(t)}var $=function(e){return{sessionExpiryMinutes:43200,method:"essential",sameSite:"lax",getSession:function(t){return e.session.findFirst({where:{handle:t}})},getSessions:function(t){return e.session.findMany({where:{userId:t}})},createSession:function(t){var r;return t.userId&&(r={connect:{id:t.userId}}),e.session.create({data:v({},t,{userId:void 0,user:r})})},updateSession:(t=f(_.mark((function t(r,n){return _.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.session.update({where:{handle:r},data:n});case 3:return t.abrupt("return",t.sent);case 6:if(t.prev=6,t.t0=t.catch(0),"P2016"!==t.t0.code){t.next=12;break}console.log("Could not update session because it's not in the DB"),t.next=13;break;case 12:throw t.t0;case 13:case"end":return t.stop()}}),t,null,[[0,6]])}))),function(e,r){return t.apply(this,arguments)}),deleteSession:function(t){return e.session.delete({where:{handle:t}})},isAuthorized:function(){throw new Error("No isAuthorized implementation provided")}};var t},Q=function(e){return"cookies"in e},W=function(e){return"blitzCtx"in e};function X(){return(X=f(_.mark((function e(t,r,n){var o,a,i;return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=$(t),"cookies"in r||(r.cookies=l.getCookieParser(r)()),V(Q(r),"[getSessionContext]: Request type isn't NextApiRequest"),!W(n)||!n.blitzCtx.session){e.next=5;break}return e.abrupt("return",n.blitzCtx.session);case 5:return e.next=7,ye(o,r,n);case 7:if((a=e.sent)&&console.log("Got existing session",a),a){e.next=14;break}return console.log("No session found, creating anonymous session"),e.next=13,xe(o,r,n);case 13:a=e.sent;case 14:return i=new Z(o,r,n,a),"blitzCtx"in n||(n.blitzCtx={}),n.blitzCtx.session=i,e.abrupt("return",i);case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Z=function(){function e(e,t,r,n){this.config=e,this._req=t,this._res=r,this._kernel=n}var t=e.prototype;return t.authorize=function(e){var t=new O;if(Error.captureStackTrace(t,this.authorize),!this.userId)throw t;if(!this.isAuthorized(e)){var r=new P;throw Error.captureStackTrace(r,this.authorize),r}},t.isAuthorized=function(e){return!!this.userId&&this.config.isAuthorized(this.roles,e)},t.create=function(){var e=f(_.mark((function e(t,r){return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,we(this.config,this._req,this._res,t,r,{jwtPayload:this._kernel.jwtPayload});case 2:this._kernel=e.sent;case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),t.revoke=function(){return _e(this.config,this._req,this._res,this.handle)},t.revokeAll=function(){var e=f(_.mark((function e(){return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.publicData.userId){e.next=2;break}throw new Error("session.revokeAll() cannot be used with anonymous sessions");case 2:return e.next=4,Te(this.config,this._req,this._res,this.publicData.userId);case 4:return e.abrupt("return");case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.setPublicData=function(){var e=f(_.mark((function e(t){return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.userId||!t.roles){e.next=3;break}return e.next=3,Ee(this.config,this.userId,t.roles);case 3:return e.next=5,Ne(this.config,this._req,this._res,this._kernel,t);case 5:this._kernel.publicData=e.sent;case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.getPrivateData=function(){var e=f(_.mark((function e(){return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Re(this.config,this.handle);case 2:if(e.t0=e.sent,e.t0){e.next=5;break}e.t0={};case 5:return e.abrupt("return",e.t0);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.setPrivateData=function(e){return function(e,t,r){return ze.apply(this,arguments)}(this.config,this._kernel,e)},d(e,[{key:"handle",get:function(){return this._kernel.handle}},{key:"userId",get:function(){return this._kernel.publicData.userId}},{key:"roles",get:function(){return this._kernel.publicData.roles}},{key:"publicData",get:function(){return this._kernel.publicData}}]),e}(),ee=function(){return A(32)+":ots"},te=function(){return A(32)+":ajwt"},re=function(e,t){var r;return r="string"==typeof t?t:JSON.stringify(t),i.toBase64([e,A(32),T(r),K].join(";"))},ne=function(e){var t=i.fromBase64(e).split(";"),r=t[0],n=t[1],o=t[2],a=t[3];if(!(r&&n&&o&&a))throw new O("Failed to parse session token");return{handle:r,id:n,hashedPublicData:o,version:a}},oe=function(e){var t="string"==typeof e?e:JSON.stringify(e);return i.toBase64(t)},ae=function(){return A(32)},ie=function(){return V(process.env.SESSION_SECRET_KEY,"You must provide the SESSION_SECRET_KEY environment variable in production. This used to sign and verify tokens. It should be 32 chars long."),V(process.env.SESSION_SECRET_KEY.length>=32,"The SESSION_SECRET_KEY environment variable must be at least 32 bytes for sufficent token security"),process.env.SESSION_SECRET_KEY},se=function(e){var t;return c.sign(((t={}).blitzjs=e,t),ie(),{algorithm:"HS256",issuer:"blitzjs",audience:"blitzjs",subject:"anonymous"})},ue=function(e){var t=ie();try{var r=c.verify(e,t,{algorithms:["HS256"],issuer:"blitzjs",audience:"blitzjs",subject:"anonymous"});return"object"==typeof r?r.blitzjs:null}catch(e){return null}},ce=function(e,t){!function(e,t,r){var n=e.getHeader("Set-Cookie"),o=r;void 0!==n&&(o=Array.isArray(n)?n.concat(r):Array.isArray(r)?[n].concat(r):[n,r]),o=Array.isArray(o)?o.map(String):String(o),e.setHeader("Set-Cookie",o)}(e,0,t)},le=function(e,t,r){e.setHeader(t,r),"_blitz"in e&&(e._blitz[t]=r)},pe=function(e,t){e.removeHeader(t),"_blitz"in e&&delete e._blitz[t]},fe=function(e,t,r,n,o){ce(r,s.serialize("sSessionToken",n,{path:"/",httpOnly:!0,secure:!process.env.DISABLE_SECURE_COOKIES&&!J(t),sameSite:e.sameSite,domain:e.domain,expires:o}))},he=function(e,t,r,n,o){ce(r,s.serialize("sAnonymousSessionToken",n,{path:"/",httpOnly:!0,secure:!process.env.DISABLE_SECURE_COOKIES&&!J(t),sameSite:e.sameSite,domain:e.domain,expires:o}))},de=function(e,t,r,n,o){console.log("setCSRFCookie",n),ce(r,s.serialize("sAntiCrfToken",n,{path:"/",secure:!process.env.DISABLE_SECURE_COOKIES&&!J(t),sameSite:e.sameSite,domain:e.domain,expires:o}))},ve=function(e,t,r,n,o){le(r,"public-data-token","updated"),ce(r,s.serialize("sPublicDataToken",n,{path:"/",secure:!process.env.DISABLE_SECURE_COOKIES&&!J(t),sameSite:e.sameSite,domain:e.domain,expires:o}))};function ye(e,t,r){return be.apply(this,arguments)}function be(){return(be=f(_.mark((function e(t,r,n){var o,a,i,s,c,l,p,f,h,d,v,y,b;return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=r.cookies.sAnonymousSessionToken,a=r.cookies.sSessionToken,i=r.cookies.sIdRefreshToken,s="GET"!==r.method&&"OPTIONS"!==r.method&&!process.env.DISABLE_CSRF_PROTECTION,c=r.headers["anti-csrf"],!a){e.next=42;break}if(console.log("[getSession] Request has sessionToken"),l=ne(a),f=l.version,h=l.hashedPublicData,p=l.handle){e.next=11;break}return console.log("No handle in sessionToken"),e.abrupt("return",null);case 11:if(f===K){e.next=14;break}return console.log(new O("Session token version is not "+K)),e.abrupt("return",null);case 14:return e.next=16,t.getSession(p);case 16:if(d=e.sent){e.next=20;break}return console.log("Session not found in DB"),e.abrupt("return",null);case 20:if(d.hashedSessionToken===T(a)){e.next=25;break}return console.log("sessionToken hash did not match"),console.log("persisted: ",d.hashedSessionToken),console.log("in req: ",T(a)),e.abrupt("return",null);case 25:if(!d.expiresAt||!u.isPast(d.expiresAt)){e.next=28;break}return console.log("Session expired"),e.abrupt("return",null);case 28:if(!s||d.antiCSRFToken===c){e.next=31;break}throw le(n,"csrf-error","true"),new C;case 31:if("GET"===r.method){e.next=39;break}if((v=T(d.publicData)!==h)&&console.log("PublicData has changed since the last request"),(y=d.expiresAt&&u.differenceInMinutes(d.expiresAt,new Date)<.75*t.sessionExpiryMinutes)&&(console.log("quarter expiry time has passed"),console.log("Persisted expire time",d.expiresAt)),!v&&!y){e.next=39;break}return e.next=39,ke(t,r,n,{handle:p,publicData:JSON.parse(d.publicData||""),jwtPayload:null,antiCSRFToken:c,sessionToken:a},{publicDataChanged:v});case 39:return e.abrupt("return",{handle:p,publicData:JSON.parse(d.publicData||""),jwtPayload:null,antiCSRFToken:c,sessionToken:a});case 42:if(!i){e.next=46;break}return e.abrupt("return",null);case 46:if(!o){e.next=56;break}if(console.log("Request has anonymousSessionToken"),b=ue(o)){e.next=52;break}return console.log("Payload empty"),e.abrupt("return",null);case 52:if(!s||b.antiCSRFToken===c){e.next=55;break}throw le(n,"csrf-error","true"),new C;case 55:return e.abrupt("return",{handle:b.handle,publicData:b.publicData,jwtPayload:b,antiCSRFToken:c,anonymousSessionToken:o});case 56:return e.abrupt("return",null);case 57:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function we(e,t,r,n,o,a){return me.apply(this,arguments)}function me(){return(me=f(_.mark((function e(t,r,n,o,a,i){var s,c,l,p,f,h,d,y,b,w,m,x,g,k,S,E;return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===a&&(a={}),void 0===i&&(i={}),V(void 0!==o.userId,"You must provide publicData.userId"),V(o.roles,"You must provide publicData.roles"),s=ae(),!i.anonymous){e.next=19;break}return console.log("Creating new anonymous session"),c=te(),p=se(l={isAnonymous:!0,handle:c,publicData:o,antiCSRFToken:s}),f=oe(o),h=u.addYears(new Date,30),he(t,r,n,p,h),de(t,r,n,s,h),ve(t,r,n,f,h),fe(t,r,n,"",new Date(0)),e.abrupt("return",{handle:c,publicData:o,jwtPayload:l,antiCSRFToken:s,anonymousSessionToken:p});case 19:if("essential"!==t.method){e.next=47;break}if(console.log("Creating new session"),V((b=v({},(null==(d=i.jwtPayload)?void 0:d.publicData)||{},o)).userId,"You must provide a non-empty userId as publicData.userId"),w={},null==(y=i.jwtPayload)||!y.isAnonymous){e.next=32;break}return e.next=27,t.getSession(i.jwtPayload.handle);case 27:if(!(m=e.sent)){e.next=32;break}return m.privateData&&(w=JSON.parse(m.privateData)),e.next=32,t.deleteSession(i.jwtPayload.handle);case 32:return x=v({},w,a),g=u.addMinutes(new Date,t.sessionExpiryMinutes),k=ee(),S=re(k,b),E=oe(b),e.next=39,t.createSession({expiresAt:g,handle:k,userId:b.userId,hashedSessionToken:T(S),antiCSRFToken:s,publicData:JSON.stringify(b),privateData:JSON.stringify(x)});case 39:return fe(t,r,n,S,g),de(t,r,n,s,g),ve(t,r,n,E,g),he(t,r,n,"",new Date(0)),pe(n,"session-revoked"),e.abrupt("return",{handle:k,publicData:b,jwtPayload:null,antiCSRFToken:s,sessionToken:S});case 47:if("advanced"!==t.method){e.next=51;break}throw new Error("The advanced method is not yet supported");case 51:throw new Error("Session management method "+t.method+' is invalid. Supported methods are "essential" and "advanced"');case 52:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function xe(e,t,r){return ge.apply(this,arguments)}function ge(){return(ge=f(_.mark((function e(t,r,n){return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,we(t,r,n,{userId:null,roles:[]},void 0,{anonymous:!0});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ke(e,t,r,n,o){return Se.apply(this,arguments)}function Se(){return(Se=f(_.mark((function e(t,r,n,o,a){var i,s,c,l,p,f,h,d,y;return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=a.publicDataChanged,console.log("Refreshing session",o),null==(i=o.jwtPayload)||!i.isAnonymous){e.next=12;break}c=v({},o.jwtPayload,{publicData:o.publicData}),l=se(c),p=oe(o.publicData),f=u.addYears(new Date,30),he(t,r,n,l,f),ve(t,r,n,p,f),de(t,r,n,o.antiCSRFToken,f),e.next=31;break;case 12:if("essential"!==t.method||!("sessionToken"in o)){e.next=29;break}if(h=u.addMinutes(new Date,t.sessionExpiryMinutes),d=oe(o.publicData),y=s?re(o.handle,o.publicData):o.sessionToken,fe(t,r,n,y,h),ve(t,r,n,d,h),de(t,r,n,o.antiCSRFToken,h),console.log("Updating session in db with",{expiresAt:h}),!s){e.next=25;break}return e.next=23,t.updateSession(o.handle,{expiresAt:h,hashedSessionToken:T(y),publicData:JSON.stringify(o.publicData)});case 23:e.next=27;break;case 25:return e.next=27,t.updateSession(o.handle,{expiresAt:h});case 27:e.next=31;break;case 29:if("advanced"!==t.method){e.next=31;break}throw new Error("refreshSession() not implemented for advanced method");case 31:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ee(e,t,r){return De.apply(this,arguments)}function De(){return(De=f(_.mark((function e(t,r,n){var o,a,i,s;return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.getSessions(r);case 2:o=E(e.sent);case 4:if((a=o()).done){e.next=11;break}return i=a.value,s=JSON.stringify(v({},i.publicData?JSON.parse(i.publicData):{},{roles:n})),e.next=9,t.updateSession(i.handle,{publicData:s});case 9:e.next=4;break;case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function _e(e,t,r,n,o){return Oe.apply(this,arguments)}function Oe(){return(Oe=f(_.mark((function e(t,r,n,o,a){return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===a&&(a=!1),console.log("Revoking session",o),a){e.next=10;break}return e.prev=3,e.next=6,t.deleteSession(o);case 6:e.next=10;break;case 8:e.prev=8,e.t0=e.catch(3);case 10:le(n,"session-revoked","true"),fe(t,r,n,"",new Date(0)),he(t,r,n,"",new Date(0)),de(t,r,n,"",new Date(0));case 14:case"end":return e.stop()}}),e,null,[[3,8]])})))).apply(this,arguments)}function Ce(e,t,r,n){return Pe.apply(this,arguments)}function Pe(){return(Pe=f(_.mark((function e(t,r,n,o){var a,i,s,u;return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=[],i=E(o);case 2:if((s=i()).done){e.next=9;break}return u=s.value,e.next=6,_e(t,r,n,u);case 6:a.push(u);case 7:e.next=2;break;case 9:return e.abrupt("return",a);case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Te(e,t,r,n){return Ae.apply(this,arguments)}function Ae(){return(Ae=f(_.mark((function e(t,r,n,o){var a;return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.getSessions(o);case 2:return a=e.sent.map((function(e){return e.handle})),e.abrupt("return",Ce(t,r,n,a));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function je(e,t){return Ie.apply(this,arguments)}function Ie(){return(Ie=f(_.mark((function e(t,r){var n,o,a;return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==(n=r.jwtPayload)||!n.publicData){e.next=4;break}return e.abrupt("return",null==(o=r.jwtPayload)?void 0:o.publicData);case 4:return e.next=6,t.getSession(r.handle);case 6:if(a=e.sent){e.next=9;break}throw new Error("getPublicData() failed because handle doesn't exist "+r.handle);case 9:if(!a.publicData){e.next=13;break}return e.abrupt("return",JSON.parse(a.publicData));case 13:return e.abrupt("return",{});case 14:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Re(e,t){return Le.apply(this,arguments)}function Le(){return(Le=f(_.mark((function e(t,r){var n;return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.getSession(r);case 2:if(!(n=e.sent)||!n.privateData){e.next=7;break}return e.abrupt("return",JSON.parse(n.privateData));case 7:return e.abrupt("return",null);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ze(){return(ze=f(_.mark((function e(t,r,n){var o,a;return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Re(t,r.handle);case 2:if(null!==(o=e.sent)){e.next=12;break}return e.prev=4,e.next=7,t.createSession({handle:r.handle});case 7:e.next=11;break;case 9:e.prev=9,e.t0=e.catch(4);case 11:o={};case 12:return a=JSON.stringify(v({},o,n)),e.next=15,t.updateSession(r.handle,{privateData:a});case 15:case"end":return e.stop()}}),e,null,[[4,9]])})))).apply(this,arguments)}function Ne(e,t,r,n,o){return qe.apply(this,arguments)}function qe(){return(qe=f(_.mark((function e(t,r,n,o,a){var i;return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return delete a.userId,e.t0=v,e.t1={},e.next=5,je(t,o);case 5:return e.t2=e.sent,e.t3=a,i=(0,e.t0)(e.t1,e.t2,e.t3),e.next=10,ke(t,r,n,v({},o,{publicData:i}),{publicDataChanged:!0});case 10:return e.abrupt("return",i);case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}exports.AuthenticationError=O,exports.authenticateUser=z,exports.getSessionContext=function(e,t,r){return X.apply(this,arguments)},exports.hashPassword=R,exports.passportAuth=function(e){return function(){var t=f(_.mark((function t(r,n){var i,s,u,c,l,p,h,d;return _.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=o({secret:process.env.SESSION_SECRET_KEY||"default-dev-secret",secure:!J(r)}),s=a.initialize(),u=[U(i),U(s),U(a.session())],e.secureProxy&&u.push(H),r.query.auth.length){t.next=6;break}return t.abrupt("return",n.status(404).end());case 6:return G(e.strategies.length,"No Passport strategies found! Please add at least one strategy."),G(c=e.strategies.find((function(e){return e.strategy.name===r.query.auth[0]})),"A passport strategy was not found for: "+r.query.auth[0]),p=c.authenticateOptions,a.use(l=c.strategy),h=l.name,1===r.query.auth.length?(console.log("Starting authentication via "+h+"..."),r.query.redirectUrl&&u.push(function(){var e=f(_.mark((function e(t,r,n){var o,a;return _.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return G(a=r.blitzCtx.session,"Missing Blitz sessionMiddleware!"),e.next=4,a.setPublicData(((o={})._redirectUrl=t.query.redirectUrl,o));case 4:return e.abrupt("return",n());case 5:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}()),u.push(U(a.authenticate(h,v({},p))))):"callback"===r.query.auth[1]&&(console.log("Processing callback for "+h+"..."),u.push(U((function(t,r,n){var o=r.blitzCtx.session;G(o,"Missing Blitz sessionMiddleware!"),a.authenticate(h,function(){var t=f(_.mark((function t(n,a){var i,s;return _.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,(i=n)||(!1===a&&(console.log("Login via "+h+" failed - usually this means the user did not authenticate properly with the provider"),i="Login failed"),G("object"==typeof a&&null!==a,"Your '"+h+"' passport verify callback returned empty data. Ensure you call 'done(null, {publicData: {userId: 1, roles: ['myRole']}})')"),G(a.publicData,"'publicData' is missing from your '"+h+"' passport verify callback. Ensure you call 'done(null, {publicData: {userId: 1, roles: ['myRole']}})')")),s=a&&"object"==typeof a&&a.redirectUrl||o.publicData._redirectUrl||(i?e.errorRedirectUrl:e.successRedirectUrl)||"/",!i){t.next=11;break}return s+="?authError="+encodeURIComponent(i.toString()),r.setHeader("Location",s),r.statusCode=302,r.end(),t.abrupt("return");case 11:return G("object"==typeof(u=a)&&null!==u&&"publicData"in u,"Passport verify callback is invalid"),delete a.publicData._redirectUrl,t.next=15,o.create(a.publicData,a.privateData);case 15:r.setHeader("Location",s),r.statusCode=302,r.end(),t.next=25;break;case 20:t.prev=20,t.t0=t.catch(0),console.error(t.t0),r.statusCode=500,r.end();case 25:case"end":return t.stop()}var u}),t,null,[[0,20]])})));return function(e,r){return t.apply(this,arguments)}}())(t,r,n)})))),d=N({}),t.next=16,q(r,n,[].concat(d,u));case 16:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}()},exports.verifyPassword=L;
//# sourceMappingURL=next-passport.cjs.production.min.js.map
